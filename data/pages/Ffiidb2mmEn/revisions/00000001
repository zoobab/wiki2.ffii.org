## -*- dok: ffiidb2mm; lang: en; coding: iso-8859-1; mode: fundamental; -*-
= FFIIDB2MM: update mailman based on project membership database =
-->
[ [:FfiidistsEn: ffiidists]
| [:FfiiprojKreEn: creating projects]
| [:MailmanEn: mailman]
| [:MlhtDbEn: mlht db]
| [:AktivEn: aktiv]
| [:Ffiimm2dbEn: ffiimm2db]
| [:GenbaEn: genba]
| [:PolisEn: computing]
| [:FfiiprojNewsEn: project news]
| [:CvsdirAdmBinEn: where in CVS]
]
----

== News & Chronology ==

 * 2004-10-17 phm makes the script generate the dists (mailaddress lists) on its own by copying and modifying parts of [:FfiidistsEn: ffiidists]
 * 2004-10-16 phm adds mailaddress list (dist) age check after a disaster that could have been prevented by such a check
 * 2003-00-00 phm creates the script [:MailmanProjlistsEn: projlists.mailman]

== Synopsis ==

The script

	/home/list/ffii/bin/ffiidb2mm

gives out some info on its usage when invoked with commandline option '-h'

	$ ffiidb2mm -h

Typical invocations are

	$ ffiidb2mm -v 3 /var/www/ffii/verein/home/nenri/uk-help/dist
	$ ffiidb2mm -v 3 /var/www/ffii/verein/home/nenri/uk-*/dist
	$ ffiidb2mm -v 3  

Line 1 will update the uk-help project list based on mailing addresses found in the file.

Line 2 does the same for all uk-* project lists, line 3 for all projects.

'-v 3' means verbosity level 3.

When mailing lists belong to projects and do not yet exist, the script creates them with default configurations.  There are also commandline options for reconfiguring existing lists.

When a mailaddress list file is too old (more than 4h by default, this can be changed with the -a option), the script generates a new one from the database.

== Dependencies ==

ffiiidb2mm must be run by user 'list'.

It expects a file /var/www/ffii/verein/home/index.en.html to be present and to belong to group 'www-data' (the group that apache can read).  All dist files generated by ffiidb2mm are written to

	/var/www/ffii/verein/home/$proj-{news,parl,help,resp}.stat
	/var/www/ffii/verein/home/nenri/$proj-{news,parl,help,resp}/dist

with owner list and group www-data.

The stat files can be used by by webpages (e.g. via SSI).  The nenri/*/dist files
are hidden behind a password barrier nenri/.htaccess.

The same files can also be written with the

	$ ffiidists proj
	$ ffiidists proj uk
	$ ffiidists proj uk-parl

and in this case usually belong to other users, such as 'knecht', but
the same group.  This implies that umask must be '0002'.  Also the
users 'list', 'knecht' and others must have access to certain tables
in the 'ffii' database.  The 'projprmhlp' table is temporarily
generated by both ffiidists and ffiidb2mm and all rights to it are
granted to the sql user group 'ffii', of which 'list' and 'knecht' are
members.

== Invocation ==

ffiimm2db is invoked once every night via daily.mailman from the
crontab of user 'list'.

If ffiimm2db finds dist files that are less than 15 minutes old, it does not recreate them.  This time interval is set with commandline option '-a 900' (age 900 seconds) in daily.mailman.  It can be lowered to '-a 60' (1 minute) but better not to 0 or very few seconds, because otherwise even the dist file created by the script itself will be judged too old and then nothing will happen.  

The age comparison allows cooperation with other scripts such as 'ffiidist' that prepare dist files, but this feature is now not really needed anymore.  In fact the future of 'ffiidb2mm' is likely to lie in even shorter time intervals, e.g. immediate writing to mailman as soon as someone has subscribed to the database via aktiv, by a minutely cronjob, using the 'faru' field of table 'projhlp' (this has already been implemented for the 'subs' table mailing lists, see 'minutely.mailman', but we are waiting for [:AktivEn: aktiv] to provide a similar feature for the project lists as well).

== Editing & Extension ==

The script is found in the ffii cvs archive at the [:CvsdirAdmBinEn: ffii admin script location].



	
